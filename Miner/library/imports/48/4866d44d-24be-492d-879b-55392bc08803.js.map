{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\Script\\pomelo/assets\\Script\\pomelo\\pomelo-creator-client.js"],"names":["Emitter","obj","mixin","key","prototype","on","addEventListener","event","fn","_callbacks","push","once","self","off","apply","arguments","removeListener","removeAllListeners","removeEventListener","length","callbacks","cb","i","splice","emit","args","slice","call","len","listeners","hasListeners","window","EventEmitter","exports","ByteArray","global","Protocol","PKG_HEAD_BYTES","MSG_FLAG_BYTES","MSG_ROUTE_CODE_BYTES","MSG_ID_MAX_BYTES","MSG_ROUTE_LEN_BYTES","MSG_ROUTE_CODE_MAX","MSG_COMPRESS_ROUTE_MASK","MSG_TYPE_MASK","Package","Message","TYPE_HANDSHAKE","TYPE_HANDSHAKE_ACK","TYPE_HEARTBEAT","TYPE_DATA","TYPE_KICK","TYPE_REQUEST","TYPE_NOTIFY","TYPE_RESPONSE","TYPE_PUSH","strencode","str","byteArray","offset","charCode","charCodeAt","codes","j","_buffer","copyArray","strdecode","buffer","bytes","array","end","String","fromCharCode","encode","type","body","index","decode","rs","id","compressRoute","route","msg","idBytes","msgHasId","caculateMsgIdBytes","msgLen","msgHasRoute","Error","encodeMsgFlag","encodeMsgId","encodeMsgRoute","encodeMsgBody","bytesLen","byteLength","flag","m","parseInt","Math","pow","routeLen","bodyLen","dest","doffset","src","soffset","copy","tmp","next","floor","module","Buffer","Uint8Array","Protobuf","init","opts","encoder","encoderProtos","decoder","decoderProtos","protobuf","constants","TYPES","uInt32","sInt32","int32","double","string","message","float","Util","util","isSimpleType","Codec","codec","ArrayBuffer","float32Array","Float32Array","float64Array","Float64Array","uInt8Array","encodeUInt32","n","isNaN","result","encodeSInt32","abs","decodeUInt32","decodeSInt32","encodeFloat","decodeFloat","encodeDouble","subarray","decodeDouble","encodeStr","code","encode2UTF8","decodeStr","codeLength","MsgEncoder","constant","protos","checkMsg","JSON","stringify","encodeMsg","name","proto","option","console","warn","__messages","writeBytes","encodeTag","tag","encodeProp","encodeArray","value","tmpBuffer","MsgDecoder","setProtos","buf","decodeMsg","head","getHead","__tags","decodeProp","decodeArray","isFinish","peekHead","getBytes","peekBytes","pos","b","cc","Pomelo","JS_WS_CLIENT_TYPE","JS_WS_CLIENT_VERSION","decodeIO_protobuf","decodeIO_encoder","decodeIO_decoder","rsa","disconnectCb","sys","localStorage","RES_OK","RES_FAIL","RES_OLD_CLIENT","Object","create","o","F","root","pomelo","socket","reqId","handlers","routeMap","dict","abbrs","serverProtos","clientProtos","protoVersion","heartbeatInterval","heartbeatTimeout","nextHeartbeatTimeout","gapThreshold","heartbeatId","heartbeatTimeoutId","handshakeCallback","reconnect","reconncetTimer","reconnectUrl","reconnectAttempts","reconnectionDelay","DEFAULT_MAX_RECONNECT_ATTEMPTS","useCrypto","handshakeBuffer","version","initCallback","params","host","port","defaultEncode","defaultDecode","url","user","encrypt","generate","data","rsa_n","toString","rsa_e","e","connect","deCompose","lookup","Builder","build","encodeNB","log","maxReconnectAttempts","getItem","parse","server","client","loadJson","onopen","reset","send","onmessage","processPackage","Date","now","onerror","error","onclose","setTimeout","WebSocket","binaryType","disconnect","close","clearTimeout","request","sendMessage","notify","sig","signString","packet","handler","heartbeat","heartbeatTimeoutCb","gap","handshake","handshakeInit","onData","processMessage","onKick","msgs","Array","isArray","processMessageBatch","l","initData"],"mappings":"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","file":"pomelo-creator-client.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\Script\\pomelo","sourcesContent":["\r\n(function(){\r\n\r\n  /**\r\n   * Expose `Emitter`.\r\n   */\r\n\r\n  // module.exports = Emitter;\r\n\r\n  /**\r\n   * Initialize a new `Emitter`.\r\n   *\r\n   * @api public\r\n   */\r\n\r\n  function Emitter(obj) {\r\n    if (obj) return mixin(obj);\r\n  };\r\n\r\n  /**\r\n   * Mixin the emitter properties.\r\n   *\r\n   * @param {Object} obj\r\n   * @return {Object}\r\n   * @api private\r\n   */\r\n\r\n  function mixin(obj) {\r\n    for (var key in Emitter.prototype) {\r\n      obj[key] = Emitter.prototype[key];\r\n    }\r\n    return obj;\r\n  }\r\n\r\n  /**\r\n   * Listen on the given `event` with `fn`.\r\n   *\r\n   * @param {String} event\r\n   * @param {Function} fn\r\n   * @return {Emitter}\r\n   * @api public\r\n   */\r\n\r\n  Emitter.prototype.on =\r\n  Emitter.prototype.addEventListener = function(event, fn){\r\n    this._callbacks = this._callbacks || {};\r\n    (this._callbacks[event] = this._callbacks[event] || [])\r\n      .push(fn);\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Adds an `event` listener that will be invoked a single\r\n   * time then automatically removed.\r\n   *\r\n   * @param {String} event\r\n   * @param {Function} fn\r\n   * @return {Emitter}\r\n   * @api public\r\n   */\r\n\r\n  Emitter.prototype.once = function(event, fn){\r\n    var self = this;\r\n    this._callbacks = this._callbacks || {};\r\n\r\n    function on() {\r\n      self.off(event, on);\r\n      fn.apply(this, arguments);\r\n    }\r\n\r\n    on.fn = fn;\r\n    this.on(event, on);\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Remove the given callback for `event` or all\r\n   * registered callbacks.\r\n   *\r\n   * @param {String} event\r\n   * @param {Function} fn\r\n   * @return {Emitter}\r\n   * @api public\r\n   */\r\n\r\n  Emitter.prototype.off =\r\n  Emitter.prototype.removeListener =\r\n  Emitter.prototype.removeAllListeners =\r\n  Emitter.prototype.removeEventListener = function(event, fn){\r\n    this._callbacks = this._callbacks || {};\r\n\r\n    // all\r\n    if (0 == arguments.length) {\r\n      this._callbacks = {};\r\n      return this;\r\n    }\r\n\r\n    // specific event\r\n    var callbacks = this._callbacks[event];\r\n    if (!callbacks) return this;\r\n\r\n    // remove all handlers\r\n    if (1 == arguments.length) {\r\n      delete this._callbacks[event];\r\n      return this;\r\n    }\r\n\r\n    // remove specific handler\r\n    var cb;\r\n    for (var i = 0; i < callbacks.length; i++) {\r\n      cb = callbacks[i];\r\n      if (cb === fn || cb.fn === fn) {\r\n        callbacks.splice(i, 1);\r\n        break;\r\n      }\r\n    }\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Emit `event` with the given args.\r\n   *\r\n   * @param {String} event\r\n   * @param {Mixed} ...\r\n   * @return {Emitter}\r\n   */\r\n\r\n  Emitter.prototype.emit = function(event){\r\n    this._callbacks = this._callbacks || {};\r\n    var args = [].slice.call(arguments, 1)\r\n      , callbacks = this._callbacks[event];\r\n\r\n    if (callbacks) {\r\n      callbacks = callbacks.slice(0);\r\n      for (var i = 0, len = callbacks.length; i < len; ++i) {\r\n        callbacks[i].apply(this, args);\r\n      }\r\n    }\r\n\r\n    return this;\r\n  };\r\n\r\n  /**\r\n   * Return array of callbacks for `event`.\r\n   *\r\n   * @param {String} event\r\n   * @return {Array}\r\n   * @api public\r\n   */\r\n\r\n  Emitter.prototype.listeners = function(event){\r\n    this._callbacks = this._callbacks || {};\r\n    return this._callbacks[event] || [];\r\n  };\r\n\r\n  /**\r\n   * Check if this emitter has `event` handlers.\r\n   *\r\n   * @param {String} event\r\n   * @return {Boolean}\r\n   * @api public\r\n   */\r\n\r\n  Emitter.prototype.hasListeners = function(event){\r\n    return !! this.listeners(event).length;\r\n  };\r\n\r\n  if(typeof(window) != \"undefined\") {\r\n    window.EventEmitter = Emitter;\r\n  }\r\n\r\n})();\r\n\r\n(function (exports, ByteArray, global) {\r\n  var Protocol = exports;\r\n\r\n  var PKG_HEAD_BYTES = 4;\r\n  var MSG_FLAG_BYTES = 1;\r\n  var MSG_ROUTE_CODE_BYTES = 2;\r\n  var MSG_ID_MAX_BYTES = 5;\r\n  var MSG_ROUTE_LEN_BYTES = 1;\r\n\r\n  var MSG_ROUTE_CODE_MAX = 0xffff;\r\n\r\n  var MSG_COMPRESS_ROUTE_MASK = 0x1;\r\n  var MSG_TYPE_MASK = 0x7;\r\n\r\n  var Package = Protocol.Package = {};\r\n  var Message = Protocol.Message = {};\r\n\r\n  Package.TYPE_HANDSHAKE = 1;\r\n  Package.TYPE_HANDSHAKE_ACK = 2;\r\n  Package.TYPE_HEARTBEAT = 3;\r\n  Package.TYPE_DATA = 4;\r\n  Package.TYPE_KICK = 5;\r\n\r\n  Message.TYPE_REQUEST = 0;\r\n  Message.TYPE_NOTIFY = 1;\r\n  Message.TYPE_RESPONSE = 2;\r\n  Message.TYPE_PUSH = 3;\r\n\r\n  /**\r\n   * pomele client encode\r\n   * id message id;\r\n   * route message route\r\n   * msg message body\r\n   * socketio current support string\r\n   */\r\n  Protocol.strencode = function(str) {\r\n    var byteArray = new ByteArray(str.length * 3);\r\n    var offset = 0;\r\n    for(var i = 0; i < str.length; i++){\r\n      var charCode = str.charCodeAt(i);\r\n      var codes = null;\r\n      if(charCode <= 0x7f){\r\n        codes = [charCode];\r\n      }else if(charCode <= 0x7ff){\r\n        codes = [0xc0|(charCode>>6), 0x80|(charCode & 0x3f)];\r\n      }else{\r\n        codes = [0xe0|(charCode>>12), 0x80|((charCode & 0xfc0)>>6), 0x80|(charCode & 0x3f)];\r\n      }\r\n      for(var j = 0; j < codes.length; j++){\r\n        byteArray[offset] = codes[j];\r\n        ++offset;\r\n      }\r\n    }\r\n    var _buffer = new ByteArray(offset);\r\n    copyArray(_buffer, 0, byteArray, 0, offset);\r\n    return _buffer;\r\n  };\r\n\r\n  /**\r\n   * client decode\r\n   * msg String data\r\n   * return Message Object\r\n   */\r\n  Protocol.strdecode = function(buffer) {\r\n    var bytes = new ByteArray(buffer);\r\n    var array = [];\r\n    var offset = 0;\r\n    var charCode = 0;\r\n    var end = bytes.length;\r\n    while(offset < end){\r\n      if(bytes[offset] < 128){\r\n        charCode = bytes[offset];\r\n        offset += 1;\r\n      }else if(bytes[offset] < 224){\r\n        charCode = ((bytes[offset] & 0x3f)<<6) + (bytes[offset+1] & 0x3f);\r\n        offset += 2;\r\n      }else{\r\n        charCode = ((bytes[offset] & 0x0f)<<12) + ((bytes[offset+1] & 0x3f)<<6) + (bytes[offset+2] & 0x3f);\r\n        offset += 3;\r\n      }\r\n      array.push(charCode);\r\n    }\r\n    return String.fromCharCode.apply(null, array);\r\n  };\r\n\r\n  /**\r\n   * Package protocol encode.\r\n   *\r\n   * Pomelo package format:\r\n   * +------+-------------+------------------+\r\n   * | type | body length |       body       |\r\n   * +------+-------------+------------------+\r\n   *\r\n   * Head: 4bytes\r\n   *   0: package type,\r\n   *      1 - handshake,\r\n   *      2 - handshake ack,\r\n   *      3 - heartbeat,\r\n   *      4 - data\r\n   *      5 - kick\r\n   *   1 - 3: big-endian body length\r\n   * Body: body length bytes\r\n   *\r\n   * @param  {Number}    type   package type\r\n   * @param  {ByteArray} body   body content in bytes\r\n   * @return {ByteArray}        new byte array that contains encode result\r\n   */\r\n  Package.encode = function(type, body){\r\n    var length = body ? body.length : 0;\r\n    var buffer = new ByteArray(PKG_HEAD_BYTES + length);\r\n    var index = 0;\r\n    buffer[index++] = type & 0xff;\r\n    buffer[index++] = (length >> 16) & 0xff;\r\n    buffer[index++] = (length >> 8) & 0xff;\r\n    buffer[index++] = length & 0xff;\r\n    if(body) {\r\n      copyArray(buffer, index, body, 0, length);\r\n    }\r\n    return buffer;\r\n  };\r\n\r\n  /**\r\n   * Package protocol decode.\r\n   * See encode for package format.\r\n   *\r\n   * @param  {ByteArray} buffer byte array containing package content\r\n   * @return {Object}           {type: package type, buffer: body byte array}\r\n   */\r\n  Package.decode = function(buffer){\r\n    var offset = 0;\r\n    var bytes = new ByteArray(buffer);\r\n    var length = 0;\r\n    var rs = [];\r\n    while(offset < bytes.length) {\r\n      var type = bytes[offset++];\r\n      length = ((bytes[offset++]) << 16 | (bytes[offset++]) << 8 | bytes[offset++]) >>> 0;\r\n      var body = length ? new ByteArray(length) : null;\r\n      copyArray(body, 0, bytes, offset, length);\r\n      offset += length;\r\n      rs.push({'type': type, 'body': body});\r\n    }\r\n    return rs.length === 1 ? rs[0]: rs;\r\n  };\r\n\r\n  /**\r\n   * Message protocol encode.\r\n   *\r\n   * @param  {Number} id            message id\r\n   * @param  {Number} type          message type\r\n   * @param  {Number} compressRoute whether compress route\r\n   * @param  {Number|String} route  route code or route string\r\n   * @param  {Buffer} msg           message body bytes\r\n   * @return {Buffer}               encode result\r\n   */\r\n  Message.encode = function(id, type, compressRoute, route, msg){\r\n    // caculate message max length\r\n    var idBytes = msgHasId(type) ? caculateMsgIdBytes(id) : 0;\r\n    var msgLen = MSG_FLAG_BYTES + idBytes;\r\n\r\n    if(msgHasRoute(type)) {\r\n      if(compressRoute) {\r\n        if(typeof route !== 'number'){\r\n          throw new Error('error flag for number route!');\r\n        }\r\n        msgLen += MSG_ROUTE_CODE_BYTES;\r\n      } else {\r\n        msgLen += MSG_ROUTE_LEN_BYTES;\r\n        if(route) {\r\n          route = Protocol.strencode(route);\r\n          if(route.length>255) {\r\n            throw new Error('route maxlength is overflow');\r\n          }\r\n          msgLen += route.length;\r\n        }\r\n      }\r\n    }\r\n\r\n    if(msg) {\r\n      msgLen += msg.length;\r\n    }\r\n\r\n    var buffer = new ByteArray(msgLen);\r\n    var offset = 0;\r\n\r\n    // add flag\r\n    offset = encodeMsgFlag(type, compressRoute, buffer, offset);\r\n\r\n    // add message id\r\n    if(msgHasId(type)) {\r\n      offset = encodeMsgId(id, buffer, offset);\r\n    }\r\n\r\n    // add route\r\n    if(msgHasRoute(type)) {\r\n      offset = encodeMsgRoute(compressRoute, route, buffer, offset);\r\n    }\r\n\r\n    // add body\r\n    if(msg) {\r\n      offset = encodeMsgBody(msg, buffer, offset);\r\n    }\r\n\r\n    return buffer;\r\n  };\r\n\r\n  /**\r\n   * Message protocol decode.\r\n   *\r\n   * @param  {Buffer|Uint8Array} buffer message bytes\r\n   * @return {Object}            message object\r\n   */\r\n  Message.decode = function(buffer) {\r\n    var bytes =  new ByteArray(buffer);\r\n    var bytesLen = bytes.length || bytes.byteLength;\r\n    var offset = 0;\r\n    var id = 0;\r\n    var route = null;\r\n\r\n    // parse flag\r\n    var flag = bytes[offset++];\r\n    var compressRoute = flag & MSG_COMPRESS_ROUTE_MASK;\r\n    var type = (flag >> 1) & MSG_TYPE_MASK;\r\n\r\n    // parse id\r\n    if(msgHasId(type)) {\r\n      var m = parseInt(bytes[offset]);\r\n      var i = 0;\r\n      do{\r\n        var m = parseInt(bytes[offset]);\r\n        id = id + ((m & 0x7f) * Math.pow(2,(7*i)));\r\n        offset++;\r\n        i++;\r\n      }while(m >= 128);\r\n    }\r\n\r\n    // parse route\r\n    if(msgHasRoute(type)) {\r\n      if(compressRoute) {\r\n        route = (bytes[offset++]) << 8 | bytes[offset++];\r\n      } else {\r\n        var routeLen = bytes[offset++];\r\n        if(routeLen) {\r\n          route = new ByteArray(routeLen);\r\n          copyArray(route, 0, bytes, offset, routeLen);\r\n          route = Protocol.strdecode(route);\r\n        } else {\r\n          route = '';\r\n        }\r\n        offset += routeLen;\r\n      }\r\n    }\r\n\r\n    // parse body\r\n    var bodyLen = bytesLen - offset;\r\n    var body = new ByteArray(bodyLen);\r\n\r\n    copyArray(body, 0, bytes, offset, bodyLen);\r\n\r\n    return {'id': id, 'type': type, 'compressRoute': compressRoute,\r\n            'route': route, 'body': body};\r\n  };\r\n\r\n  var copyArray = function(dest, doffset, src, soffset, length) {\r\n    if('function' === typeof src.copy) {\r\n      // Buffer\r\n      src.copy(dest, doffset, soffset, soffset + length);\r\n    } else {\r\n      // Uint8Array\r\n      for(var index=0; index<length; index++){\r\n        dest[doffset++] = src[soffset++];\r\n      }\r\n    }\r\n  };\r\n\r\n  var msgHasId = function(type) {\r\n    return type === Message.TYPE_REQUEST || type === Message.TYPE_RESPONSE;\r\n  };\r\n\r\n  var msgHasRoute = function(type) {\r\n    return type === Message.TYPE_REQUEST || type === Message.TYPE_NOTIFY ||\r\n           type === Message.TYPE_PUSH;\r\n  };\r\n\r\n  var caculateMsgIdBytes = function(id) {\r\n    var len = 0;\r\n    do {\r\n      len += 1;\r\n      id >>= 7;\r\n    } while(id > 0);\r\n    return len;\r\n  };\r\n\r\n  var encodeMsgFlag = function(type, compressRoute, buffer, offset) {\r\n    if(type !== Message.TYPE_REQUEST && type !== Message.TYPE_NOTIFY &&\r\n       type !== Message.TYPE_RESPONSE && type !== Message.TYPE_PUSH) {\r\n      throw new Error('unkonw message type: ' + type);\r\n    }\r\n\r\n    buffer[offset] = (type << 1) | (compressRoute ? 1 : 0);\r\n\r\n    return offset + MSG_FLAG_BYTES;\r\n  };\r\n\r\n  var encodeMsgId = function(id, buffer, offset) {\r\n    do{\r\n      var tmp = id % 128;\r\n      var next = Math.floor(id/128);\r\n\r\n      if(next !== 0){\r\n        tmp = tmp + 128;\r\n      }\r\n      buffer[offset++] = tmp;\r\n\r\n      id = next;\r\n    } while(id !== 0);\r\n\r\n    return offset;\r\n  };\r\n\r\n  var encodeMsgRoute = function(compressRoute, route, buffer, offset) {\r\n    if (compressRoute) {\r\n      if(route > MSG_ROUTE_CODE_MAX){\r\n        throw new Error('route number is overflow');\r\n      }\r\n\r\n      buffer[offset++] = (route >> 8) & 0xff;\r\n      buffer[offset++] = route & 0xff;\r\n    } else {\r\n      if(route) {\r\n        buffer[offset++] = route.length & 0xff;\r\n        copyArray(buffer, offset, route, 0, route.length);\r\n        offset += route.length;\r\n      } else {\r\n        buffer[offset++] = 0;\r\n      }\r\n    }\r\n\r\n    return offset;\r\n  };\r\n\r\n  var encodeMsgBody = function(msg, buffer, offset) {\r\n    copyArray(buffer, offset, msg, 0, msg.length);\r\n    return offset + msg.length;\r\n  };\r\n\r\n  // module.exports = Protocol;\r\n  if(typeof(window) != \"undefined\") {\r\n    window.Protocol = Protocol;\r\n  }\r\n})(typeof(window)==\"undefined\" ? module.exports : ({}),typeof(window)==\"undefined\"  ? Buffer : Uint8Array, this);\r\n\r\n/* ProtocolBuffer client 0.1.0*/\r\n\r\n/**\r\n * pomelo-protobuf\r\n * @author <zhang0935@gmail.com>\r\n */\r\n\r\n/**\r\n * Protocol buffer root\r\n * In browser, it will be window.protbuf\r\n */\r\n(function (exports, global){\r\n  var Protobuf = exports;\r\n\r\n  Protobuf.init = function(opts){\r\n    //On the serverside, use serverProtos to encode messages send to client\r\n    Protobuf.encoder.init(opts.encoderProtos);\r\n\r\n    //On the serverside, user clientProtos to decode messages receive from clients\r\n    Protobuf.decoder.init(opts.decoderProtos);\r\n  };\r\n\r\n  Protobuf.encode = function(key, msg){\r\n    return Protobuf.encoder.encode(key, msg);\r\n  };\r\n\r\n  Protobuf.decode = function(key, msg){\r\n    return Protobuf.decoder.decode(key, msg);\r\n  };\r\n\r\n  // exports to support for components\r\n  // module.exports = Protobuf;\r\n  if(typeof(window) != \"undefined\") {\r\n    window.protobuf = Protobuf;\r\n  }\r\n  \r\n})(typeof(window) == \"undefined\" ? module.exports : ({}), this);\r\n\r\n/**\r\n * constants\r\n */\r\n(function (exports, global){\r\n  var constants = exports.constants = {};\r\n\r\n  constants.TYPES = {\r\n    uInt32 : 0,\r\n    sInt32 : 0,\r\n    int32 : 0,\r\n    double : 1,\r\n    string : 2,\r\n    message : 2,\r\n    float : 5\r\n  };\r\n\r\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\r\n\r\n/**\r\n * util module\r\n */\r\n(function (exports, global){\r\n\r\n  var Util = exports.util = {};\r\n\r\n  Util.isSimpleType = function(type){\r\n    return ( type === 'uInt32' ||\r\n             type === 'sInt32' ||\r\n             type === 'int32'  ||\r\n             type === 'uInt64' ||\r\n             type === 'sInt64' ||\r\n             type === 'float'  ||\r\n             type === 'double' );\r\n  };\r\n\r\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\r\n\r\n/**\r\n * codec module\r\n */\r\n(function (exports, global){\r\n\r\n  var Codec = exports.codec = {};\r\n\r\n  var buffer = new ArrayBuffer(8);\r\n  var float32Array = new Float32Array(buffer);\r\n  var float64Array = new Float64Array(buffer);\r\n  var uInt8Array = new Uint8Array(buffer);\r\n\r\n  Codec.encodeUInt32 = function(n){\r\n    var n = parseInt(n);\r\n    if(isNaN(n) || n < 0){\r\n      return null;\r\n    }\r\n\r\n    var result = [];\r\n    do{\r\n      var tmp = n % 128;\r\n      var next = Math.floor(n/128);\r\n\r\n      if(next !== 0){\r\n        tmp = tmp + 128;\r\n      }\r\n      result.push(tmp);\r\n      n = next;\r\n    }while(n !== 0);\r\n\r\n    return result;\r\n  };\r\n\r\n  Codec.encodeSInt32 = function(n){\r\n    var n = parseInt(n);\r\n    if(isNaN(n)){\r\n      return null;\r\n    }\r\n    n = n<0?(Math.abs(n)*2-1):n*2;\r\n\r\n    return Codec.encodeUInt32(n);\r\n  };\r\n\r\n  Codec.decodeUInt32 = function(bytes){\r\n    var n = 0;\r\n\r\n    for(var i = 0; i < bytes.length; i++){\r\n      var m = parseInt(bytes[i]);\r\n      n = n + ((m & 0x7f) * Math.pow(2,(7*i)));\r\n      if(m < 128){\r\n        return n;\r\n      }\r\n    }\r\n\r\n    return n;\r\n  };\r\n\r\n  Codec.decodeSInt32 = function(bytes){\r\n    var n = this.decodeUInt32(bytes);\r\n    var flag = ((n%2) === 1)?-1:1;\r\n\r\n    n = ((n%2 + n)/2)*flag;\r\n\r\n    return n;\r\n  };\r\n\r\n  Codec.encodeFloat = function(float){\r\n    float32Array[0] = float;\r\n    return uInt8Array;\r\n  };\r\n\r\n  Codec.decodeFloat = function(bytes, offset){\r\n    if(!bytes || bytes.length < (offset + 4)){\r\n      return null;\r\n    }\r\n\r\n    for(var i = 0; i < 4; i++){\r\n      uInt8Array[i] = bytes[offset + i];\r\n    }\r\n\r\n    return float32Array[0];\r\n  };\r\n\r\n  Codec.encodeDouble = function(double){\r\n    float64Array[0] = double;\r\n    return uInt8Array.subarray(0, 8);\r\n  };\r\n\r\n  Codec.decodeDouble = function(bytes, offset){\r\n    if(!bytes || bytes.length < (offset + 8)){\r\n      return null;\r\n    }\r\n\r\n    for(var i = 0; i < 8; i++){\r\n      uInt8Array[i] = bytes[offset + i];\r\n    }\r\n\r\n    return float64Array[0];\r\n  };\r\n\r\n  Codec.encodeStr = function(bytes, offset, str){\r\n    for(var i = 0; i < str.length; i++){\r\n      var code = str.charCodeAt(i);\r\n      var codes = encode2UTF8(code);\r\n\r\n      for(var j = 0; j < codes.length; j++){\r\n        bytes[offset] = codes[j];\r\n        offset++;\r\n      }\r\n    }\r\n\r\n    return offset;\r\n  };\r\n\r\n  /**\r\n   * Decode string from utf8 bytes\r\n   */\r\n  Codec.decodeStr = function(bytes, offset, length){\r\n    var array = [];\r\n    var end = offset + length;\r\n\r\n    while(offset < end){\r\n      var code = 0;\r\n\r\n      if(bytes[offset] < 128){\r\n        code = bytes[offset];\r\n\r\n        offset += 1;\r\n      }else if(bytes[offset] < 224){\r\n        code = ((bytes[offset] & 0x3f)<<6) + (bytes[offset+1] & 0x3f);\r\n        offset += 2;\r\n      }else{\r\n        code = ((bytes[offset] & 0x0f)<<12) + ((bytes[offset+1] & 0x3f)<<6) + (bytes[offset+2] & 0x3f);\r\n        offset += 3;\r\n      }\r\n\r\n      array.push(code);\r\n\r\n    }\r\n\r\n    var str = '';\r\n    for(var i = 0; i < array.length;){\r\n      str += String.fromCharCode.apply(null, array.slice(i, i + 10000));\r\n      i += 10000;\r\n    }\r\n\r\n    return str;\r\n  };\r\n\r\n  /**\r\n   * Return the byte length of the str use utf8\r\n   */\r\n  Codec.byteLength = function(str){\r\n    if(typeof(str) !== 'string'){\r\n      return -1;\r\n    }\r\n\r\n    var length = 0;\r\n\r\n    for(var i = 0; i < str.length; i++){\r\n      var code = str.charCodeAt(i);\r\n      length += codeLength(code);\r\n    }\r\n\r\n    return length;\r\n  };\r\n\r\n  /**\r\n   * Encode a unicode16 char code to utf8 bytes\r\n   */\r\n  function encode2UTF8(charCode){\r\n    if(charCode <= 0x7f){\r\n      return [charCode];\r\n    }else if(charCode <= 0x7ff){\r\n      return [0xc0|(charCode>>6), 0x80|(charCode & 0x3f)];\r\n    }else{\r\n      return [0xe0|(charCode>>12), 0x80|((charCode & 0xfc0)>>6), 0x80|(charCode & 0x3f)];\r\n    }\r\n  }\r\n\r\n  function codeLength(code){\r\n    if(code <= 0x7f){\r\n      return 1;\r\n    }else if(code <= 0x7ff){\r\n      return 2;\r\n    }else{\r\n      return 3;\r\n    }\r\n  }\r\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\r\n\r\n/**\r\n * encoder module\r\n */\r\n(function (exports, global){\r\n\r\n  var protobuf = exports;\r\n  var MsgEncoder = exports.encoder = {};\r\n\r\n  var codec = protobuf.codec;\r\n  var constant = protobuf.constants;\r\n  var util = protobuf.util;\r\n\r\n  MsgEncoder.init = function(protos){\r\n    this.protos = protos || {};\r\n  };\r\n\r\n  MsgEncoder.encode = function(route, msg){\r\n    //Get protos from protos map use the route as key\r\n    var protos = this.protos[route];\r\n\r\n    //Check msg\r\n    if(!checkMsg(msg, protos)){\r\n      return null;\r\n    }\r\n\r\n    //Set the length of the buffer 2 times bigger to prevent overflow\r\n    var length = codec.byteLength(JSON.stringify(msg));\r\n\r\n    //Init buffer and offset\r\n    var buffer = new ArrayBuffer(length);\r\n    var uInt8Array = new Uint8Array(buffer);\r\n    var offset = 0;\r\n\r\n    if(!!protos){\r\n      offset = encodeMsg(uInt8Array, offset, protos, msg);\r\n      if(offset > 0){\r\n        return uInt8Array.subarray(0, offset);\r\n      }\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  /**\r\n   * Check if the msg follow the defination in the protos\r\n   */\r\n  function checkMsg(msg, protos){\r\n    if(!protos){\r\n      return false;\r\n    }\r\n\r\n    for(var name in protos){\r\n      var proto = protos[name];\r\n\r\n      //All required element must exist\r\n      switch(proto.option){\r\n        case 'required' :\r\n          if(typeof(msg[name]) === 'undefined'){\r\n            console.warn('no property exist for required! name: %j, proto: %j, msg: %j', name, proto, msg);\r\n            return false;\r\n          }\r\n        case 'optional' :\r\n          if(typeof(msg[name]) !== 'undefined'){\r\n            var message = protos.__messages[proto.type] || MsgEncoder.protos['message ' + proto.type];\r\n            if(!!message && !checkMsg(msg[name], message)){\r\n              console.warn('inner proto error! name: %j, proto: %j, msg: %j', name, proto, msg);\r\n              return false;\r\n            }\r\n          }\r\n        break;\r\n        case 'repeated' :\r\n          //Check nest message in repeated elements\r\n          var message = protos.__messages[proto.type] || MsgEncoder.protos['message ' + proto.type];\r\n          if(!!msg[name] && !!message){\r\n            for(var i = 0; i < msg[name].length; i++){\r\n              if(!checkMsg(msg[name][i], message)){\r\n                return false;\r\n              }\r\n            }\r\n          }\r\n        break;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function encodeMsg(buffer, offset, protos, msg){\r\n    for(var name in msg){\r\n      if(!!protos[name]){\r\n        var proto = protos[name];\r\n\r\n        switch(proto.option){\r\n          case 'required' :\r\n          case 'optional' :\r\n            offset = writeBytes(buffer, offset, encodeTag(proto.type, proto.tag));\r\n            offset = encodeProp(msg[name], proto.type, offset, buffer, protos);\r\n          break;\r\n          case 'repeated' :\r\n            if(msg[name].length > 0){\r\n              offset = encodeArray(msg[name], proto, offset, buffer, protos);\r\n            }\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    return offset;\r\n  }\r\n\r\n  function encodeProp(value, type, offset, buffer, protos){\r\n    switch(type){\r\n      case 'uInt32':\r\n        offset = writeBytes(buffer, offset, codec.encodeUInt32(value));\r\n      break;\r\n      case 'int32' :\r\n      case 'sInt32':\r\n        offset = writeBytes(buffer, offset, codec.encodeSInt32(value));\r\n      break;\r\n      case 'float':\r\n        writeBytes(buffer, offset, codec.encodeFloat(value));\r\n        offset += 4;\r\n      break;\r\n      case 'double':\r\n        writeBytes(buffer, offset, codec.encodeDouble(value));\r\n        offset += 8;\r\n      break;\r\n      case 'string':\r\n        var length = codec.byteLength(value);\r\n\r\n        //Encode length\r\n        offset = writeBytes(buffer, offset, codec.encodeUInt32(length));\r\n        //write string\r\n        codec.encodeStr(buffer, offset, value);\r\n        offset += length;\r\n      break;\r\n      default :\r\n        var message = protos.__messages[type] || MsgEncoder.protos['message ' + type];\r\n        if(!!message){\r\n          //Use a tmp buffer to build an internal msg\r\n          var tmpBuffer = new ArrayBuffer(codec.byteLength(JSON.stringify(value))*2);\r\n          var length = 0;\r\n\r\n          length = encodeMsg(tmpBuffer, length, message, value);\r\n          //Encode length\r\n          offset = writeBytes(buffer, offset, codec.encodeUInt32(length));\r\n          //contact the object\r\n          for(var i = 0; i < length; i++){\r\n            buffer[offset] = tmpBuffer[i];\r\n            offset++;\r\n          }\r\n        }\r\n      break;\r\n    }\r\n\r\n    return offset;\r\n  }\r\n\r\n  /**\r\n   * Encode reapeated properties, simple msg and object are decode differented\r\n   */\r\n  function encodeArray(array, proto, offset, buffer, protos){\r\n    var i = 0;\r\n\r\n    if(util.isSimpleType(proto.type)){\r\n      offset = writeBytes(buffer, offset, encodeTag(proto.type, proto.tag));\r\n      offset = writeBytes(buffer, offset, codec.encodeUInt32(array.length));\r\n      for(i = 0; i < array.length; i++){\r\n        offset = encodeProp(array[i], proto.type, offset, buffer);\r\n      }\r\n    }else{\r\n      for(i = 0; i < array.length; i++){\r\n        offset = writeBytes(buffer, offset, encodeTag(proto.type, proto.tag));\r\n        offset = encodeProp(array[i], proto.type, offset, buffer, protos);\r\n      }\r\n    }\r\n\r\n    return offset;\r\n  }\r\n\r\n  function writeBytes(buffer, offset, bytes){\r\n    for(var i = 0; i < bytes.length; i++, offset++){\r\n      buffer[offset] = bytes[i];\r\n    }\r\n\r\n    return offset;\r\n  }\r\n\r\n  function encodeTag(type, tag){\r\n    var value = constant.TYPES[type]||2;\r\n\r\n    return codec.encodeUInt32((tag<<3)|value);\r\n  }\r\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\r\n\r\n/**\r\n * decoder module\r\n */\r\n(function (exports, global){\r\n  var protobuf = exports;\r\n  var MsgDecoder = exports.decoder = {};\r\n\r\n  var codec = protobuf.codec;\r\n  var util = protobuf.util;\r\n\r\n  var buffer;\r\n  var offset = 0;\r\n\r\n  MsgDecoder.init = function(protos){\r\n    this.protos = protos || {};\r\n  };\r\n\r\n  MsgDecoder.setProtos = function(protos){\r\n    if(!!protos){\r\n      this.protos = protos;\r\n    }\r\n  };\r\n\r\n  MsgDecoder.decode = function(route, buf){\r\n    var protos = this.protos[route];\r\n\r\n    buffer = buf;\r\n    offset = 0;\r\n\r\n    if(!!protos){\r\n      return decodeMsg({}, protos, buffer.length);\r\n    }\r\n\r\n    return null;\r\n  };\r\n\r\n  function decodeMsg(msg, protos, length){\r\n    while(offset<length){\r\n      var head = getHead();\r\n      var type = head.type;\r\n      var tag = head.tag;\r\n      var name = protos.__tags[tag];\r\n\r\n      switch(protos[name].option){\r\n        case 'optional' :\r\n        case 'required' :\r\n          msg[name] = decodeProp(protos[name].type, protos);\r\n        break;\r\n        case 'repeated' :\r\n          if(!msg[name]){\r\n            msg[name] = [];\r\n          }\r\n          decodeArray(msg[name], protos[name].type, protos);\r\n        break;\r\n      }\r\n    }\r\n\r\n    return msg;\r\n  }\r\n\r\n  /**\r\n   * Test if the given msg is finished\r\n   */\r\n  function isFinish(msg, protos){\r\n    return (!protos.__tags[peekHead().tag]);\r\n  }\r\n  /**\r\n   * Get property head from protobuf\r\n   */\r\n  function getHead(){\r\n    var tag = codec.decodeUInt32(getBytes());\r\n\r\n    return {\r\n      type : tag&0x7,\r\n      tag : tag>>3\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get tag head without move the offset\r\n   */\r\n  function peekHead(){\r\n    var tag = codec.decodeUInt32(peekBytes());\r\n\r\n    return {\r\n      type : tag&0x7,\r\n      tag : tag>>3\r\n    };\r\n  }\r\n\r\n  function decodeProp(type, protos){\r\n    switch(type){\r\n      case 'uInt32':\r\n        return codec.decodeUInt32(getBytes());\r\n      case 'int32' :\r\n      case 'sInt32' :\r\n        return codec.decodeSInt32(getBytes());\r\n      case 'float' :\r\n        var float = codec.decodeFloat(buffer, offset);\r\n        offset += 4;\r\n        return float;\r\n      case 'double' :\r\n        var double = codec.decodeDouble(buffer, offset);\r\n        offset += 8;\r\n        return double;\r\n      case 'string' :\r\n        var length = codec.decodeUInt32(getBytes());\r\n\r\n        var str =  codec.decodeStr(buffer, offset, length);\r\n        offset += length;\r\n\r\n        return str;\r\n      default :\r\n        var message = protos && (protos.__messages[type] || MsgDecoder.protos['message ' + type]);\r\n        if(!!message){\r\n          var length = codec.decodeUInt32(getBytes());\r\n          var msg = {};\r\n          decodeMsg(msg, message, offset+length);\r\n          return msg;\r\n        }\r\n      break;\r\n    }\r\n  }\r\n\r\n  function decodeArray(array, type, protos){\r\n    if(util.isSimpleType(type)){\r\n      var length = codec.decodeUInt32(getBytes());\r\n\r\n      for(var i = 0; i < length; i++){\r\n        array.push(decodeProp(type));\r\n      }\r\n    }else{\r\n      array.push(decodeProp(type, protos));\r\n    }\r\n  }\r\n\r\n  function getBytes(flag){\r\n    var bytes = [];\r\n    var pos = offset;\r\n    flag = flag || false;\r\n\r\n    var b;\r\n\r\n    do{\r\n      b = buffer[pos];\r\n      bytes.push(b);\r\n      pos++;\r\n    }while(b >= 128);\r\n\r\n    if(!flag){\r\n      offset = pos;\r\n    }\r\n    return bytes;\r\n  }\r\n\r\n  function peekBytes(){\r\n    return getBytes(true);\r\n  }\r\n\r\n})('undefined' !== typeof protobuf ? protobuf : module.exports, this);\r\n\r\ncc.Pomelo = function() {\r\n  var JS_WS_CLIENT_TYPE = 'js-websocket';\r\n  var JS_WS_CLIENT_VERSION = '0.0.1';\r\n\r\n  var Protocol = window.Protocol;\r\n  var protobuf = window.protobuf;\r\n  var decodeIO_protobuf = window.decodeIO_protobuf;\r\n  var decodeIO_encoder = null;\r\n  var decodeIO_decoder = null;\r\n  var Package = Protocol.Package;\r\n  var Message = Protocol.Message;\r\n  var EventEmitter = window.EventEmitter;\r\n  var rsa = window.rsa;\r\n  var disconnectCb = null;\r\n\r\n  if(typeof(window) != \"undefined\" && typeof(sys) != 'undefined' && sys.localStorage) {\r\n    window.localStorage = sys.localStorage;\r\n  }\r\n  \r\n  var RES_OK = 200;\r\n  var RES_FAIL = 500;\r\n  var RES_OLD_CLIENT = 501;\r\n\r\n  if (typeof Object.create !== 'function') {\r\n    Object.create = function (o) {\r\n      function F() {}\r\n      F.prototype = o;\r\n      return new F();\r\n    };\r\n  }\r\n\r\n  var root = window;\r\n  var pomelo = Object.create(EventEmitter.prototype); // object extend from object\r\n  // root.pomelo = pomelo;\r\n  var socket = null;\r\n  var reqId = 0;\r\n  var callbacks = {};\r\n  var handlers = {};\r\n  //Map from request id to route\r\n  var routeMap = {};\r\n  var dict = {};    // route string to code\r\n  var abbrs = {};   // code to route string\r\n  var serverProtos = {};\r\n  var clientProtos = {};\r\n  var protoVersion = 0;\r\n\r\n  var heartbeatInterval = 0;\r\n  var heartbeatTimeout = 0;\r\n  var nextHeartbeatTimeout = 0;\r\n  var gapThreshold = 100;   // heartbeat gap threashold\r\n  var heartbeatId = null;\r\n  var heartbeatTimeoutId = null;\r\n  var handshakeCallback = null;\r\n\r\n  var decode = null;\r\n  var encode = null;\r\n\r\n  var reconnect = false;\r\n  var reconncetTimer = null;\r\n  var reconnectUrl = null;\r\n  var reconnectAttempts = 0;\r\n  var reconnectionDelay = 5000;\r\n  var DEFAULT_MAX_RECONNECT_ATTEMPTS = 10;\r\n\r\n  var useCrypto;\r\n\r\n  var handshakeBuffer = {\r\n    'sys': {\r\n      type: JS_WS_CLIENT_TYPE,\r\n      version: JS_WS_CLIENT_VERSION,\r\n      rsa: {}\r\n    },\r\n    'user': {\r\n    }\r\n  };\r\n\r\n  var initCallback = null;\r\n\r\n  pomelo.init = function(params, cb) {\r\n    initCallback = cb;\r\n    var host = params.host;\r\n    var port = params.port;\r\n\r\n    encode = params.encode || defaultEncode;\r\n    decode = params.decode || defaultDecode;\r\n\r\n    var url = 'ws://' + host;\r\n    if(port) {\r\n      url +=  ':' + port;\r\n    }\r\n\r\n    handshakeBuffer.user = params.user;\r\n    if(params.encrypt) {\r\n      useCrypto = true;\r\n      rsa.generate(1024, \"10001\");\r\n      var data = {\r\n        rsa_n: rsa.n.toString(16),\r\n        rsa_e: rsa.e\r\n      }\r\n      handshakeBuffer.sys.rsa = data;\r\n    }\r\n    handshakeCallback = params.handshakeCallback;\r\n    connect(params, url, cb);\r\n  };\r\n\r\n  var defaultDecode = pomelo.decode = function(data) {\r\n    //probuff decode\r\n    var msg = Message.decode(data);\r\n\r\n    if(msg.id > 0){\r\n      msg.route = routeMap[msg.id];\r\n      delete routeMap[msg.id];\r\n      if(!msg.route){\r\n        return;\r\n      }\r\n    }\r\n\r\n    msg.body = deCompose(msg);\r\n    return msg;\r\n  };\r\n\r\n  var defaultEncode = pomelo.encode = function(reqId, route, msg) {\r\n    var type = reqId ? Message.TYPE_REQUEST : Message.TYPE_NOTIFY;\r\n\r\n    //compress message by protobuf\r\n    if(protobuf && clientProtos[route]) {\r\n      msg = protobuf.encode(route, msg);\r\n    } else if(decodeIO_encoder && decodeIO_encoder.lookup(route)) {\r\n      var Builder = decodeIO_encoder.build(route);\r\n      msg = new Builder(msg).encodeNB();\r\n    } else {\r\n      msg = Protocol.strencode(JSON.stringify(msg));\r\n    }\r\n\r\n    var compressRoute = 0;\r\n    if(dict && dict[route]) {\r\n      route = dict[route];\r\n      compressRoute = 1;\r\n    }\r\n\r\n    return Message.encode(reqId, type, compressRoute, route, msg);\r\n  };\r\n\r\n  var connect = function(params, url, cb) {\r\n    console.log('connect to ' + url);\r\n\r\n    var params = params || {};\r\n    var maxReconnectAttempts = params.maxReconnectAttempts || DEFAULT_MAX_RECONNECT_ATTEMPTS;\r\n    reconnectUrl = url;\r\n    //Add protobuf version\r\n    if(window.localStorage && window.localStorage.getItem('protos') && protoVersion === 0) {\r\n      var protos = JSON.parse(window.localStorage.getItem('protos'));\r\n\r\n      protoVersion = protos.version || 0;\r\n      serverProtos = protos.server || {};\r\n      clientProtos = protos.client || {};\r\n\r\n      if(!!protobuf) {\r\n        protobuf.init({encoderProtos: clientProtos, decoderProtos: serverProtos});\r\n      } \r\n      if(!!decodeIO_protobuf) {\r\n        decodeIO_encoder = decodeIO_protobuf.loadJson(clientProtos);\r\n        decodeIO_decoder = decodeIO_protobuf.loadJson(serverProtos);\r\n      }\r\n    }\r\n    //Set protoversion\r\n    handshakeBuffer.sys.protoVersion = protoVersion;\r\n\r\n    var onopen = function(event) {\r\n      if(!!reconnect) {\r\n        pomelo.emit('reconnect');\r\n      }\r\n      reset();\r\n      var obj = Package.encode(Package.TYPE_HANDSHAKE, Protocol.strencode(JSON.stringify(handshakeBuffer)));\r\n      send(obj);\r\n    };\r\n    var onmessage = function(event) {\r\n      processPackage(Package.decode(event.data), cb);\r\n      // new package arrived, update the heartbeat timeout\r\n      if(heartbeatTimeout) {\r\n        nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\r\n      }\r\n    };\r\n    var onerror = function(event) {\r\n      pomelo.emit('io-error', event);\r\n      console.error('socket error: ', event);\r\n    };\r\n    var onclose = function(event) {\r\n      pomelo.emit('close',event);\r\n      pomelo.emit('disconnect', event);\r\n      cc.log('socket close: ', event);\r\n      if(!!params.reconnect && reconnectAttempts < maxReconnectAttempts) {\r\n        reconnect = true;\r\n        reconnectAttempts++;\r\n        reconncetTimer = setTimeout(function() {\r\n          connect(params, reconnectUrl, cb);\r\n        }, reconnectionDelay);\r\n        reconnectionDelay *= 2;\r\n      }\r\n      socket = null;\r\n      disconnectCb && disconnectCb();\r\n      disconnectCb = null;\r\n    };\r\n    socket = new WebSocket(url);\r\n    socket.binaryType = 'arraybuffer';\r\n    socket.onopen = onopen;\r\n    socket.onmessage = onmessage;\r\n    socket.onerror = onerror;\r\n    socket.onclose = onclose;\r\n  };\r\n\r\n  pomelo.disconnect = function(cb) {\r\n    disconnectCb = cb;\r\n    if(socket) {\r\n      if(socket.disconnect) socket.disconnect();\r\n      if(socket.close) socket.close();\r\n      cc.log('pomelo disconnect initiative');\r\n      socket = null;\r\n    }\r\n\r\n    if(heartbeatId) {\r\n      clearTimeout(heartbeatId);\r\n      heartbeatId = null;\r\n    }\r\n    if(heartbeatTimeoutId) {\r\n      clearTimeout(heartbeatTimeoutId);\r\n      heartbeatTimeoutId = null;\r\n    }\r\n  };\r\n\r\n  var reset = function() {\r\n    reconnect = false;\r\n    reconnectionDelay = 1000 * 5;\r\n    reconnectAttempts = 0;\r\n    clearTimeout(reconncetTimer);\r\n  };\r\n\r\n  pomelo.request = function(route, msg, cb) {\r\n    if(arguments.length === 2 && typeof msg === 'function') {\r\n      cb = msg;\r\n      msg = {};\r\n    } else {\r\n      msg = msg || {};\r\n    }\r\n    route = route || msg.route;\r\n    if(!route) {\r\n      return;\r\n    }\r\n\r\n    reqId++;\r\n    sendMessage(reqId, route, msg);\r\n\r\n    callbacks[reqId] = cb;\r\n    routeMap[reqId] = route;\r\n  };\r\n\r\n  pomelo.notify = function(route, msg) {\r\n    msg = msg || {};\r\n    sendMessage(0, route, msg);\r\n  };\r\n\r\n  var sendMessage = function(reqId, route, msg) {\r\n    if(useCrypto) {\r\n      msg = JSON.stringify(msg);\r\n      var sig = rsa.signString(msg, \"sha256\");\r\n      msg = JSON.parse(msg);\r\n      msg['__crypto__'] = sig;\r\n    }\r\n\r\n    if(encode) {\r\n      msg = encode(reqId, route, msg);\r\n    }\r\n\r\n    var packet = Package.encode(Package.TYPE_DATA, msg);\r\n    send(packet);\r\n  };\r\n\r\n  var send = function(packet) {\r\n    if (socket !== null) {\r\n        socket.send(packet.buffer);\r\n    }\r\n  };\r\n\r\n  var handler = {};\r\n\r\n  var heartbeat = function(data) {\r\n    if(!heartbeatInterval) {\r\n      // no heartbeat\r\n      return;\r\n    }\r\n\r\n    var obj = Package.encode(Package.TYPE_HEARTBEAT);\r\n    if(heartbeatTimeoutId) {\r\n      clearTimeout(heartbeatTimeoutId);\r\n      heartbeatTimeoutId = null;\r\n    }\r\n\r\n    if(heartbeatId) {\r\n      // already in a heartbeat interval\r\n      return;\r\n    }\r\n    heartbeatId = setTimeout(function() {\r\n      heartbeatId = null;\r\n      send(obj);\r\n\r\n      nextHeartbeatTimeout = Date.now() + heartbeatTimeout;\r\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, heartbeatTimeout);\r\n    }, heartbeatInterval);\r\n  };\r\n\r\n  var heartbeatTimeoutCb = function() {\r\n    var gap = nextHeartbeatTimeout - Date.now();\r\n    if(gap > gapThreshold) {\r\n      heartbeatTimeoutId = setTimeout(heartbeatTimeoutCb, gap);\r\n    } else {\r\n      console.error('server heartbeat timeout');\r\n      pomelo.emit('heartbeat timeout');\r\n      pomelo.disconnect();\r\n    }\r\n  };\r\n\r\n  var handshake = function(data) {\r\n    data = JSON.parse(Protocol.strdecode(data));\r\n    if(data.code === RES_OLD_CLIENT) {\r\n      pomelo.emit('error', 'client version not fullfill');\r\n      return;\r\n    }\r\n\r\n    if(data.code !== RES_OK) {\r\n      pomelo.emit('error', 'handshake fail');\r\n      return;\r\n    }\r\n\r\n    handshakeInit(data);\r\n\r\n    var obj = Package.encode(Package.TYPE_HANDSHAKE_ACK);\r\n    send(obj);\r\n    if(initCallback) {\r\n      initCallback(socket);\r\n    }\r\n  };\r\n\r\n  var onData = function(data) {\r\n    var msg = data;\r\n    if(decode) {\r\n      msg = decode(msg);\r\n    }\r\n    processMessage(pomelo, msg);\r\n  };\r\n\r\n  var onKick = function(data) {\r\n    data = JSON.parse(Protocol.strdecode(data));\r\n    pomelo.emit('onKick', data);\r\n  };\r\n\r\n  handlers[Package.TYPE_HANDSHAKE] = handshake;\r\n  handlers[Package.TYPE_HEARTBEAT] = heartbeat;\r\n  handlers[Package.TYPE_DATA] = onData;\r\n  handlers[Package.TYPE_KICK] = onKick;\r\n\r\n  var processPackage = function(msgs) {\r\n    if(Array.isArray(msgs)) {\r\n      for(var i=0; i<msgs.length; i++) {\r\n        var msg = msgs[i];\r\n        handlers[msg.type](msg.body);\r\n      }\r\n    } else {\r\n      handlers[msgs.type](msgs.body);\r\n    }\r\n  };\r\n\r\n  var processMessage = function(pomelo, msg) {\r\n    if(!msg.id) {\r\n      // server push message\r\n      pomelo.emit(msg.route, msg.body);\r\n      return;\r\n    }\r\n\r\n    //if have a id then find the callback function with the request\r\n    var cb = callbacks[msg.id];\r\n\r\n    delete callbacks[msg.id];\r\n    if(typeof cb !== 'function') {\r\n      return;\r\n    }\r\n\r\n    cb(msg.body);\r\n    return;\r\n  };\r\n\r\n  var processMessageBatch = function(pomelo, msgs) {\r\n    for(var i=0, l=msgs.length; i<l; i++) {\r\n      processMessage(pomelo, msgs[i]);\r\n    }\r\n  };\r\n\r\n  var deCompose = function(msg) {\r\n    var route = msg.route;\r\n\r\n    //Decompose route from dict\r\n    if(msg.compressRoute) {\r\n      if(!abbrs[route]){\r\n        return {};\r\n      }\r\n\r\n      route = msg.route = abbrs[route];\r\n    }\r\n    if(protobuf && serverProtos[route]) {\r\n      return protobuf.decode(route, msg.body);\r\n    } else if(decodeIO_decoder && decodeIO_decoder.lookup(route)) {\r\n      return decodeIO_decoder.build(route).decode(msg.body);\r\n    } else {\r\n      return JSON.parse(Protocol.strdecode(msg.body));\r\n    }\r\n\r\n    return msg;\r\n  };\r\n\r\n  var handshakeInit = function(data) {\r\n    if(data.sys && data.sys.heartbeat) {\r\n      heartbeatInterval = data.sys.heartbeat * 1000;   // heartbeat interval\r\n      heartbeatTimeout = heartbeatInterval * 2;        // max heartbeat timeout\r\n    } else {\r\n      heartbeatInterval = 0;\r\n      heartbeatTimeout = 0;\r\n    }\r\n\r\n    initData(data);\r\n\r\n    if(typeof handshakeCallback === 'function') {\r\n      handshakeCallback(data.user);\r\n    }\r\n  };\r\n\r\n  //Initilize data used in pomelo client\r\n  var initData = function(data) {\r\n    if(!data || !data.sys) {\r\n      return;\r\n    }\r\n    dict = data.sys.dict;\r\n    var protos = data.sys.protos;\r\n\r\n    //Init compress dict\r\n    if(dict) {\r\n      dict = dict;\r\n      abbrs = {};\r\n\r\n      for(var route in dict) {\r\n        abbrs[dict[route]] = route;\r\n      }\r\n    }\r\n\r\n    //Init protobuf protos\r\n    if(protos) {\r\n      protoVersion = protos.version || 0;\r\n      serverProtos = protos.server || {};\r\n      clientProtos = protos.client || {};\r\n\r\n        //Save protobuf protos to localStorage\r\n        // window.localStorage.setItem('protos', JSON.stringify(protos));\r\n\r\n        if(!!protobuf) {\r\n          protobuf.init({encoderProtos: protos.client, decoderProtos: protos.server});\r\n        }\r\n        if(!!decodeIO_protobuf) {\r\n          decodeIO_encoder = decodeIO_protobuf.loadJson(clientProtos);\r\n          decodeIO_decoder = decodeIO_protobuf.loadJson(serverProtos);\r\n        }\r\n      }\r\n    };\r\n    return pomelo;\r\n    // module.exports = pomelo;\r\n  };\r\n window.pomelo=new cc.Pomelo();\r\n\r\n\r\n\r\n\r\n"]}